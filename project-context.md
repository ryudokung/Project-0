# Project Context: Project-0

## Project Overview
Project-0 is a Crypto Web Game featuring AI-generated seasonal NFTs (Mechs, Tanks, Ships) on Base L2, with a hybrid economy and a "No USDT Out" revenue model.

### Core Gameplay Pillars
- **Adaptive Universe:** AI-driven ecosystem with evolving narratives and combat logs.
- **Unified Vehicle & Pilot System:** 
    - **Mothership (The Bastion):** The strategic hub for managing the fleet and pilot progression.
    - **Bastion Modules:** Global buffs stored in the Bastion (Radar: -20% Detection/lvl, Lab: +10% Rewards/lvl, Warp: -10% Fuel/lvl).
    - **Vehicles:** Modular assets including **Mechs, Tanks, Ships, Speeders, and Haulers**. Certain classes (Tank, Ship) feature **Transformation Modules** to adapt to terrain.
    - **Pilot & Exosuit:** The "Infiltration Layer." Pilots use specialized **Exosuits** for stealth, hacking, and exploring areas inaccessible to heavy vehicles.
- **Deep Gameplay Logic (Triple-Layer Gear):**
    - **Combat Power (CP):** Standardized formula: `CP = (ATK*2) + (DEF*2) + (HP/10)`.
    - **Effective CP (ECP):** `(Vehicle_CP + Exosuit_CP) * Sync_Rate * Suitability_Mod * (1 - Fatigue_Penalty) * Synergy_Mod`.
    - **Sync Rate:** A pilot-bound multiplier (e.g., 0.5 to 1.5) representing the neural connection between pilot and machine. This replaces the traditional "Rank" system and acts as the primary growth metric for Pilots.
    - **Set Synergy:** +15% ECP bonus when Exosuit and Vehicle share the same "Series" metadata.
    - **Emergency Retrieval Protocol:** A fail-safe system that auto-warps the pilot back to the Bastion when Fuel or O2 reaches 0, with penalties (Stress, Critical Fatigue, and Reward loss).
    - **Neural Overdrive (Active Skills):** Tactical skills like **Overclock** (+30% ECP) and **Emergency Repair** (Restore HP) powered by **Neural Energy (NE)**.
    - **Damage Matrix:** Elemental damage types (**Kinetic, Energy, Void**) with specific strengths and weaknesses.
- **Modular NFT Assembly:** Every part (Railgun, Shield, Pilot Suit, Transformation Module) is an individual NFT. AI dynamically synthesizes these parts into a single visual representation.
- **Resonance & Sync Rate:** A progression system where high **Sync Rate** and **Pilot Resonance** grant **Dominance** over lower-tier sectors.
    - **Scale Suppression:** A core combat mechanic where larger units (Vehicles) naturally dominate smaller ones (Humans). Humans without Resonance suffer a 90% damage penalty against Vehicles (10% damage dealt), while Vehicles deal 300% damage to normal Humans.
    - **Resonance Mode (The Ultimate):** An active "Awakening" state for Pilots. When active, it bypasses Scale Suppression, allowing a Human to fight a Vehicle on equal terms (or even superior terms if Resonance is high).
- **Web2.5 Onboarding (Seamless Entry):** Players can join using Google, Email, or Social accounts via Privy. A **Stage Change Model** allows immediate gameplay with **Manifested Assets** in the database, with optional wallet linking and on-chain minting later.
- **Deep Durability System (DDS):** A multi-tiered item condition system (Pristine, Worn, Damaged, Critical, Broken) that affects gameplay performance and visual fidelity.
- **AI Narrative Timeline (Expedition & Encounters):** 
    - **The Expedition:** The core narrative anchor or mission objective defined by the Director (e.g., "Repairing the Radar"). It provides the context and constraints for the AI.
    - **Handcrafted Missions:** Specific story-driven expeditions (e.g., "The Iron Awakening") with fixed nodes and scripted events to introduce core mechanics like Resonance and Boss Phase Transitions.
    - **The Encounters:** Procedural sub-events and visual reveals generated by AI. These are "strung" onto the expedition based on player stats, choices, and environmental context.
    - **Boss Phase Transition:** High-tier enemies (Bosses) feature multi-stage combat. Destroying their Mech (Phase 1) triggers an "Ejection Event" where the Resonant Pilot emerges to fight on foot (Phase 2).
    - **Visual DNA Synthesis:** AI dynamically combines Vehicle DNA, Weapon DNA, and Node Environment into a unique visual prompt for each "Encounter," ensuring every moment is personalized.
    - **Context-Aware Generation:** The AI ensures that all generated encounters remain consistent with the current "Expedition" (e.g., no space travel events while on a planetary repair mission).
- **Salvage & Research:** Capture enemy units to sell, research tech, or scrap for parts.
- **Story Mode:** Structured narrative providing fixed foundation items and tutorials.

## Technical Stack & Infrastructure
- **Frontend:** Next.js 15+ (App Router), Tailwind CSS, **Decoupled Systems (EventBus + Singletons)**, XState.
- **Backend:** Go (Modular Monolith), Clean Architecture, Saga Pattern.
- **Blockchain:** Base L2, ERC-721, Privy/Dynamic (Auth).
- **AI:** FLUX.1 via Fal.ai/Replicate.
- **Database:** PostgreSQL 16.
- **Infrastructure:** Docker & Docker Compose.

## Technical Bible
- [PRD.md](_bmad-output/PRD.md): Product Requirements Document.
- [GDD.md](_bmad-output/GDD.md): Game Design Document (Samus Shepard).
- [architecture.md](_bmad-output/architecture.md): Technical Architecture & ADRs.
- [game-systems-architecture.md](_bmad-output/game-systems-architecture.md): Game Systems & Showcase Engine (Cloud Dragonborn).
- [combat-design-bible.md](_bmad-output/combat-design-bible.md): Damage Formulas, Status Effects & Battle Logic.
- [level-design-bible.md](_bmad-output/level-design-bible.md): Star Systems, Sectors & Environmental Hazards.
- [vehicle-item-bible.md](_bmad-output/vehicle-item-bible.md): Modular Parts (Vehicles, Tanks, Ships), Rarity Tiers & Visual DNA.
- [bastion-bible.md](_bmad-output/bastion-bible.md): The Command Center, Facilities, Tech Tree & DDS.
- [narrative-lore-bible.md](_bmad-output/narrative-lore-bible.md): World History, Factions & Narrative Hooks.
- [economy-bible.md](_bmad-output/economy-bible.md): Dual-Currency, Stage Change Model & Monetization.
- [ui-ux-bible.md](_bmad-output/ui-ux-bible.md): Tactical Noir HUD and User Journey.
- [player-journey.md](_bmad-output/player-journey.md): Rookie to Legend Progression & Emotional Milestones.
- [project-journey.md](_bmad-output/project-journey.md): The evolution of Tech & Design.
- [creator-studio-bible.md](_bmad-output/creator-studio-bible.md): God Mode, Context Patching & AI Guardrails.
- [epics-stories.md](_bmad-output/epics-stories.md): Implementation Roadmap.

## Critical Implementation Rules
- **Security-First Development:** Security is NOT an afterthought. Every new feature must implement server-side ownership verification, input validation, and protection against race conditions (Atomic updates).
- **Modular Monolith:** Keep domain logic separated. `auth`, `vehicle`, `exploration`, and `game` should have clear boundaries.
- **XState for Game Flow:** All high-level state transitions (Bastion -> Map -> Exploration) must be handled by the `gameMachine`.
- **Event-Driven Communication:** Use the `EventBus` for cross-component communication to keep the UI decoupled from the game logic.

## Current Progress (Epic 3: Combat & Exploration Engine)
- [x] Backend Combat Engine (Damage Formulas, Status Effects)
- [x] Modular Vehicle Infrastructure (Parts, Stats, Nullable Fields)
- [x] Interactive TUI/CLI for Combat Testing
- [x] Expedition & Encounters Database Schema (Stars, Nodes, Sessions)
- [x] Visual DNA Aggregator (Vehicle + Environment Prompt Logic)
- [x] Single-Page Game Loop (SPGL) Architecture (Frontend State Machine)
- [x] JWT Security Middleware & Ownership Verification
- [x] Anti-Cheat & Race Condition Prevention (Atomic SQL Updates)
- [x] Real Combat Integration (NPC Seeding & Exploration Wiring)
- [x] Triple-Layer Gear & ECP Logic (Pilot, Vehicle, Bastion)
- [x] Bastion Module System (Radar, Lab, Warp Drive)
- [ ] Emergency Retrieval Protocol (Implementation)
- [ ] Neural Overdrive (Active Skills) Framework
- [ ] Damage Matrix (Kinetic, Energy, Void) Integration
- [ ] AI Image Generation Integration (FLUX.1)

## Recent Technical Updates (December 2025)
### 1. Deep Gameplay Design Expansion
- **Emergency Retrieval Protocol:** Implemented a "No-Cost" fail-safe for resource depletion (0 Fuel/O2). Triggers an auto-warp with penalties: +50 Stress, 50% Reward loss, and a "Critical Fatigue" flag that reduces ECP by 50% in the next mission.
- **Neural Overdrive (Active Skills):** Designed a skill system powered by **Neural Energy (NE)**. Skills include **Overclock** (+30% ECP for 1 node) and **Emergency Repair** (Restore 30% Vehicle HP).
- **Damage Matrix:** Introduced elemental damage types. **Kinetic** (Standard), **Energy** (+20% vs Shields), and **Void** (Ignores 30% Defense).
- **V2O Minting Rules:** Established criteria for minting manifested assets: Epic+ rarity, 10+ Expeditions completed, and >80% Durability.

### 2. Game Engine Architecture (Decoupled Systems)
- **Architecture:** Refactored the frontend into a "Game Engine" pattern using a global **Event Bus** (`EventBus.ts`) and **Singleton Systems** (e.g., `ExplorationSystem.ts`).
- **YAML Blueprint System (Data-Driven Engine):** Transitioned the backend from hardcoded templates to a YAML-based Blueprint system.
    - **Single Source of Truth:** All game content (Node types, Strategic Choices, Enemy stats, Rarity tiers) is defined in `backend/blueprints/*.yaml`.
    - **Dynamic Loading:** The `BlueprintRegistry` loads these files on startup, allowing for rapid content iteration without recompiling the Go binary.
    - **Engine Consistency:** Ensures that procedural generation and node resolution always use synchronized metadata, preventing "Failed to resolve choice" errors.
- **Core Components:**
    - **Event Bus (`EventBus.ts`)**: Acts as the central nervous system. Components and systems communicate via asynchronous events, reducing direct dependencies and preventing "prop drilling".
    - **Singleton Systems**: Domain-specific logic (e.g., `ExplorationSystem`, `CombatSystem`) is encapsulated in standalone classes. These systems manage their own internal state and interact with the backend, emitting events when data changes.
    - **Reactive UI Layer**: React components are treated as a "View" layer. They subscribe to events from the Event Bus to update their local state and trigger system methods in response to user interactions.
    - **XState Orchestration**: A finite state machine (`gameMachine.ts`) manages the high-level game flow, ensuring that transitions between stages (e.g., Hangar to Exploration) are valid and consistent.
- **Benefits:** Decouples game logic from React UI components, allowing for easier scaling, better testability, and a more "Unity-like" development experience.

### 2. Authentication & Onboarding (Web2.5)
- **Auth Flow:** Implemented a hybrid authentication system. Initial login is via **Guest ID** (Local Storage) or **Social Login** (Email/Google via Privy).
- **Wallet Strategy:** Wallet linking is **NOT** required for initial login. It is treated as an optional step for later stages, specifically for minting manifested assets into on-chain NFTs.
- **Pilot Registration:** New users must complete a "Pilot Registration" (Character Creation) which initializes their `pilot_stats` and assigns a **Starter Pack** in the database.

### 3. Security & Anti-Cheat (Hardening)
- **JWT Middleware:** Implemented a robust authentication layer in Go to protect all sensitive API routes.
- **Ownership Verification:** The backend now verifies ownership of Vehicles and Expeditions for every action (Combat, Exploration).
- **Server-Authoritative State:** HP and Resource (O2/Fuel) tracking moved to the server to prevent client-side manipulation.
- **Combat Integrity:** Added checks to prevent skipping combat encounters or attacking destroyed targets.

### 3. Concurrency & Race Conditions
- **Atomic SQL Updates:** Implemented `UPDATE ... WHERE` patterns for Gacha pulls and Resource consumption to prevent "Double Spend" and race conditions during high-frequency requests.

### 4. Real Combat Integration
- **NPC Seeding:** Integrated real NPC enemy data into the exploration loop.
- **End-to-End Wiring:** Connected the exploration `enemy_id` directly to the combat engine, enabling persistent damage and loot potential.

### 5. Unified Vehicle & Pilot System (Strategic Refactor)
- **Terminology Alignment:** Renamed "Hangar" to **"Bastion"** and "Mech" to **"Vehicle"** across the frontend and backend to support a broader range of assets (Tanks, Ships, etc.).
- **Transformation Logic:** Introduced the concept of **Transformation Modules**, allowing heavy vehicles like Tanks and Ships to convert into Robot modes for tactical flexibility.
- **Infiltration Layer:** Established the **Pilot & Exosuit** system for "boots-on-the-ground" gameplay, enabling exploration of tight spaces and stealth missions.
- **Resonance Progression:** Implemented **Pilot Resonance** as a core stat that scales with player experience, influencing the **Combat Rating (CR)** and unlocking "Dominance" mechanics for high-level players.
- **Visual Equipment System:** Implemented a visual mapping interface in the Bastion for equipping modules. Items are now mapped to specific anatomical slots (**HEAD, CORE, ARM_L, ARM_R, LEGS**) overlaid on a pilot/vehicle silhouette.
- **Starter Pack Initialization:** New characters are now automatically granted a **Starter Vehicle** and two equipped modules (**Starter Kinetic Arm** and **Starter Plating**) upon creation, ensuring a "Ready-to-Play" experience.
- **Combat Power (CP) Calculation:** Implemented a standardized CP formula `(Total ATK * 2) + (Total DEF * 2) + (Total HP / 10)` to provide a clear power metric for players.
- **Modular Equipment:** Expanded the item system to include dedicated slots for both Pilots (Body, Head, Utility, Weapon) and Vehicles (Core, Armor, Weapons, Transformation, Tools).

### 6. Game Engine Architecture (Data-Driven)
- **YAML Blueprint System:** Transitioned the game engine from hardcoded templates to a data-driven architecture. Game content (Exploration Nodes, Enemies) is now defined in external YAML files (`backend/blueprints/`).
- **Blueprint Registry:** Implemented a centralized registry in Go that loads and validates YAML data on startup, enabling rapid content iteration without recompiling the backend.
- **Dynamic Encounter Generation:** The exploration service now consumes blueprints to generate procedural timelines, strategic choices, and combat encounters.

## Directory Structure
- `/backend`: Go source code.
- `/frontend`: Next.js source code.
- `/_bmad-output`: Project documentation (PRD, Architecture).
- `/_bmad`: BMad Method configuration and agents.

## Development Workflow
1. Use `docker-compose up --build` to start the environment.
2. Backend runs on `:8080`, Frontend on `:3000`.
3. Database is accessible on `:5432`.
