# Project Context: Project-0

## Project Overview
Project-0 is a Crypto Web Game featuring AI-generated seasonal NFTs (Mechs, Tanks, Ships) on Base L2, with a hybrid economy and a "No USDT Out" revenue model.

### Core Gameplay Pillars
- **Adaptive Universe:** AI-driven ecosystem with evolving narratives and combat logs.
- **Modular NFT Assembly:** Every part (Railgun, Shield, Pilot Suit) is an individual NFT. AI dynamically synthesizes these parts into a single visual representation based on the player's loadout and mission context.
- **Web2.5 Onboarding (Seamless Entry):** Players can join using Google, Email, or Social accounts via Privy. A "Virtual-to-On-chain" (V2O) model allows immediate gameplay with virtual assets in the database, with optional wallet linking and on-chain minting later.
- **Colony Management:** Upgradeable home bases that can move between star systems.
- **AI Narrative Timeline (Expedition & Encounters):** 
    - **The Expedition:** The core narrative anchor or mission objective defined by the Director (e.g., "Repairing the Radar"). It provides the context and constraints for the AI.
    - **The Encounters:** Procedural sub-events and visual reveals generated by AI. These are "strung" onto the expedition based on player stats, choices, and environmental context.
    - **Visual DNA Synthesis:** AI dynamically combines Mech DNA, Weapon DNA, and Node Environment into a unique visual prompt for each "Encounter," ensuring every moment is personalized.
    - **Context-Aware Generation:** The AI ensures that all generated encounters remain consistent with the current "Expedition" (e.g., no space travel events while on a planetary repair mission).
- **Mothership:** Space travel & atmospheric entry.
- **Salvage & Research:** Capture enemy units to sell, research tech, or scrap for parts.
- **Story Mode:** Structured narrative providing fixed foundation items and tutorials.

## Technical Stack & Infrastructure
- **Frontend:** Next.js 14+ (App Router), Tailwind CSS, Zustand.
- **Backend:** Go (Modular Monolith), Clean Architecture, Saga Pattern.
- **Blockchain:** Base L2, ERC-721, Privy/Dynamic (Auth).
- **AI:** FLUX.1 via Fal.ai/Replicate.
- **Database:** PostgreSQL 16.
- **Infrastructure:** Docker & Docker Compose.

## Technical Bible
- [PRD.md](_bmad-output/PRD.md): Product Requirements Document.
- [GDD.md](_bmad-output/GDD.md): Game Design Document (Samus Shepard).
- [architecture.md](_bmad-output/architecture.md): Technical Architecture & ADRs.
- [game-systems-architecture.md](_bmad-output/game-systems-architecture.md): Game Systems & Showcase Engine (Cloud Dragonborn).
- [combat-design-bible.md](_bmad-output/combat-design-bible.md): Damage Formulas, Status Effects & Battle Logic.
- [level-design-bible.md](_bmad-output/level-design-bible.md): Star Systems, Sectors & Environmental Hazards.
- [vehicle-item-bible.md](_bmad-output/vehicle-item-bible.md): Modular Parts (Mechs, Tanks, Ships), Rarity Tiers & Visual DNA.
- [mothership-bible.md](_bmad-output/mothership-bible.md): Facilities, Tech Tree & Deployment Methods (Teleportation).
- [narrative-lore-bible.md](_bmad-output/narrative-lore-bible.md): World History, Factions & Narrative Hooks.
- [economy-bible.md](_bmad-output/economy-bible.md): Dual-Currency, V2O Bridge & Monetization.
- [ui-ux-bible.md](_bmad-output/ui-ux-bible.md): Tactical Noir HUD and User Journey.
- [player-journey.md](_bmad-output/player-journey.md): Rookie to Legend Progression & Emotional Milestones.
- [creator-studio-bible.md](_bmad-output/creator-studio-bible.md): God Mode, Context Patching & AI Guardrails.
- [epics-stories.md](_bmad-output/epics-stories.md): Implementation Roadmap.

## Critical Implementation Rules
- **Security-First Development:** Security is NOT an afterthought. Every new feature must implement server-side ownership verification, input validation, and protection against race conditions (Atomic updates).
- **Saga Pattern:** All multi-step transactions (Assembly, Discovery) must use the Saga Pattern with idempotency keys.
- **Clean Architecture:** Go backend must follow Clean Architecture (Entities, Use Cases, Repository, Delivery).
- **Dockerized Environment:** All services must be runnable via `docker-compose up`.
- **AI Guardrails:** Use Structured Output (JSON Schema) and RAG to prevent hallucinations.
- **Housekeeping:** Temporary logs (Combat Logs) must be deleted after 7 days unless paid to save.

## Current Progress (Epic 3: Combat & Exploration Engine)
- [x] Backend Combat Engine (Damage Formulas, Status Effects)
- [x] Modular Mech Infrastructure (Parts, Stats, Nullable Fields)
- [x] Interactive TUI/CLI for Combat Testing
- [x] Expedition & Encounters Database Schema (Stars, Nodes, Sessions)
- [x] Visual DNA Aggregator (Mech + Environment Prompt Logic)
- [x] Single-Page Game Loop (SPGL) Architecture (Frontend State Machine)
- [x] JWT Security Middleware & Ownership Verification
- [x] Anti-Cheat & Race Condition Prevention (Atomic SQL Updates)
- [x] Real Combat Integration (NPC Seeding & Exploration Wiring)
- [ ] Exploration UseCase (Node selection & Event handling)
- [ ] AI Image Generation Integration (FLUX.1)

## Recent Technical Updates (December 2025)
### 1. Game Engine Architecture (Decoupled Systems)
- **Architecture:** Refactored the frontend into a "Game Engine" pattern using a global **Event Bus** (`EventBus.ts`) and **Singleton Systems** (e.g., `ExplorationSystem.ts`).
- **Core Components:**
    - **Event Bus (`EventBus.ts`)**: Acts as the central nervous system. Components and systems communicate via asynchronous events, reducing direct dependencies and preventing "prop drilling".
    - **Singleton Systems**: Domain-specific logic (e.g., `ExplorationSystem`, `CombatSystem`) is encapsulated in standalone classes. These systems manage their own internal state and interact with the backend, emitting events when data changes.
    - **Reactive UI Layer**: React components are treated as a "View" layer. They subscribe to events from the Event Bus to update their local state and trigger system methods in response to user interactions.
    - **XState Orchestration**: A finite state machine (`gameMachine.ts`) manages the high-level game flow, ensuring that transitions between stages (e.g., Hangar to Exploration) are valid and consistent.
- **Benefits:** Decouples game logic from React UI components, allowing for easier scaling, better testability, and a more "Unity-like" development experience.

### 2. Authentication & Onboarding (Web2.5)
- **Auth Flow:** Implemented a hybrid authentication system. Initial login is via **Guest ID** (Local Storage) or **Social Login** (Email/Google via Privy).
- **Wallet Strategy:** Wallet linking is **NOT** required for initial login. It is treated as an optional step for later stages, specifically for minting virtual assets into on-chain NFTs.
- **Pilot Registration:** New users must complete a "Pilot Registration" (Character Creation) which initializes their `pilot_stats` and assigns a starter vehicle in the database.

### 3. Security & Anti-Cheat (Hardening)
- **JWT Middleware:** Implemented a robust authentication layer in Go to protect all sensitive API routes.
- **Ownership Verification:** The backend now verifies ownership of Mechs and Expeditions for every action (Combat, Exploration).
- **Server-Authoritative State:** HP and Resource (O2/Fuel) tracking moved to the server to prevent client-side manipulation.
- **Combat Integrity:** Added checks to prevent skipping combat encounters or attacking destroyed targets.

### 3. Concurrency & Race Conditions
- **Atomic SQL Updates:** Implemented `UPDATE ... WHERE` patterns for Gacha pulls and Resource consumption to prevent "Double Spend" and race conditions during high-frequency requests.

### 4. Real Combat Integration
- **NPC Seeding:** Integrated real NPC enemy data into the exploration loop.
- **End-to-End Wiring:** Connected the exploration `enemy_id` directly to the combat engine, enabling persistent damage and loot potential.

## Directory Structure
- `/backend`: Go source code.
- `/frontend`: Next.js source code.
- `/_bmad-output`: Project documentation (PRD, Architecture).
- `/_bmad`: BMad Method configuration and agents.

## Development Workflow
1. Use `docker-compose up --build` to start the environment.
2. Backend runs on `:8080`, Frontend on `:3000`.
3. Database is accessible on `:5432`.
